<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="k8s,docker," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="环境操作系统：Centos7 minimal（7.4）虚拟机
以下方法包含三个节点，一个master，同时也作为node：master：192.168.78.230node1：192.168.78.229node2：192.168.78.142
使用各组件版本：docker1.12.6kubernetes1.8.6etcd3.2.17">
<meta property="og:type" content="article">
<meta property="og:title" content="从零开始:手动kubernete1.8环境搭建问题记录">
<meta property="og:url" content="http://yoursite.com/2018/01/20/21-手动k8s搭建记录/index.html">
<meta property="og:site_name" content="路途">
<meta property="og:description" content="环境操作系统：Centos7 minimal（7.4）虚拟机
以下方法包含三个节点，一个master，同时也作为node：master：192.168.78.230node1：192.168.78.229node2：192.168.78.142
使用各组件版本：docker1.12.6kubernetes1.8.6etcd3.2.17">
<meta property="og:updated_time" content="2018-07-17T07:12:26.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="从零开始:手动kubernete1.8环境搭建问题记录">
<meta name="twitter:description" content="环境操作系统：Centos7 minimal（7.4）虚拟机
以下方法包含三个节点，一个master，同时也作为node：master：192.168.78.230node1：192.168.78.229node2：192.168.78.142
使用各组件版本：docker1.12.6kubernetes1.8.6etcd3.2.17">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 从零开始:手动kubernete1.8环境搭建问题记录 | 路途 </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">路途</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            所有文章
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                从零开始:手动kubernete1.8环境搭建问题记录
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2018-01-20T02:42:56+08:00" content="2018-01-20">
              2018-01-20
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>操作系统：Centos7 minimal（7.4）虚拟机</p>
<p>以下方法包含三个节点，一个master，同时也作为node：<br>master：192.168.78.230<br>node1：192.168.78.229<br>node2：192.168.78.142</p>
<p>使用各组件版本：<br>docker1.12.6<br>kubernetes1.8.6<br>etcd3.2.17<br><a id="more"></a></p>
<h2 id="系统准备"><a href="#系统准备" class="headerlink" title="系统准备"></a>系统准备</h2><p>1、要同步集群时间，这是个大坑。</p>
<h2 id="部署准备-创建和分发证书"><a href="#部署准备-创建和分发证书" class="headerlink" title="部署准备:创建和分发证书"></a>部署准备:创建和分发证书</h2><p>1、关闭所有节点的SELinux。永久方法：修改/etc/selinux/config文件，设置SELINUX=disabled ，然后重启服务器。<br>之前kubeadm部署文章里提到的setenforce 0是临时的。done</p>
<p>2、修改所有节点hosts文件。完毕后ping测试一下。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">vi /etc/hosts</div><div class="line">127.0.0.1 localhost</div><div class="line">192.168.78.230 gsj.master.com</div><div class="line">192.168.78.229 gsj.nodeone.com</div><div class="line">192.168.78.142 gsj.nodetwo.com</div></pre></td></tr></table></figure></p>
<p>注：修改主机名时应该关注的几个文件/etc/hostname、/etc/hosts、/etc/sysconfig/network。done</p>
<p>3、所有节点禁用防火墙：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl stop firewalld</div><div class="line">systemctl disable firewalld</div></pre></td></tr></table></figure></p>
<p>done</p>
<p>4、同步集群主机时间，否则可能出错。比如我因为证书的生效时间问题导致etcd集群起不来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install ntp</div></pre></td></tr></table></figure></p>
<p>5、对于kuberentes1.8集群，必须关闭swap，否则kubelet启动将失败。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">swapoff -a</div></pre></td></tr></table></figure></p>
<h2 id="创建TLS证书和秘钥"><a href="#创建TLS证书和秘钥" class="headerlink" title="创建TLS证书和秘钥"></a>创建TLS证书和秘钥</h2><p>以下步骤仅在master节点192.168.78.230这台主机上执行。<br>1、安装 CFSSL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">yun install wget</div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</div><div class="line">chmod +x cfssl_linux-amd64</div><div class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</div><div class="line"></div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</div><div class="line">chmod +x cfssljson_linux-amd64</div><div class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</div><div class="line"></div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</div><div class="line">chmod +x cfssl-certinfo_linux-amd64</div><div class="line">mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</div><div class="line"></div><div class="line">export PATH=/usr/local/bin:$PATH</div></pre></td></tr></table></figure></p>
<p>2、创建CA配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">mkdir /opt/ssl</div><div class="line">cd /opt/ssl</div><div class="line"></div><div class="line">cat &gt; ca-config.json &lt;&lt; EOF</div><div class="line">&#123;</div><div class="line">  &quot;signing&quot;: &#123;</div><div class="line">    &quot;default&quot;: &#123;</div><div class="line">      &quot;expiry&quot;: &quot;8760h&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;profiles&quot;: &#123;</div><div class="line">      &quot;kubernetes&quot;: &#123;</div><div class="line">        &quot;usages&quot;: [</div><div class="line">            &quot;signing&quot;,</div><div class="line">            &quot;key encipherment&quot;,</div><div class="line">            &quot;server auth&quot;,</div><div class="line">            &quot;client auth&quot;</div><div class="line">        ],</div><div class="line">        &quot;expiry&quot;: &quot;8760h&quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>3、创建CA证书签名请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">cat &gt; ca-csr.json &lt;&lt; EOF</div><div class="line">&#123;</div><div class="line">  &quot;CN&quot;: &quot;kubernetes&quot;,</div><div class="line">  &quot;key&quot;: &#123;</div><div class="line">    &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">    &quot;size&quot;: 2048</div><div class="line">  &#125;,</div><div class="line">  &quot;names&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;C&quot;: &quot;CN&quot;,</div><div class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</div><div class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</div><div class="line">      &quot;O&quot;: &quot;k8s&quot;,</div><div class="line">      &quot;OU&quot;: &quot;System&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>4、生成CA证书和私钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cfssl gencert -initca ca-csr.json | cfssljson -bare ca</div></pre></td></tr></table></figure></p>
<p>5、创建kubernetes证书签名请求文件：其中hosts中ip地址分别指定了 etcd集群、kubernetes master集群的主机IP和kubernetes服务的服务IP（一般是 kube-apiserver 指定的 service-cluster-ip-range 网段的第一个IP，如 10.254.0.1）。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">cat &gt; kubernetes-csr.json &lt;&lt; EOF</div><div class="line">&#123;</div><div class="line">   &quot;CN&quot;: &quot;kubernetes&quot;,</div><div class="line">    &quot;hosts&quot;: [</div><div class="line">      &quot;127.0.0.1&quot;,</div><div class="line">      &quot;192.168.78.230&quot;,</div><div class="line">      &quot;192.168.78.229&quot;,</div><div class="line">      &quot;192.168.78.142&quot;,</div><div class="line">      &quot;10.254.0.1&quot;,</div><div class="line">      &quot;kubernetes&quot;,</div><div class="line">      &quot;kubernetes.default&quot;,</div><div class="line">      &quot;kubernetes.default.svc&quot;,</div><div class="line">      &quot;kubernetes.default.svc.cluster&quot;,</div><div class="line">      &quot;kubernetes.default.svc.cluster.local&quot;</div><div class="line">    ],</div><div class="line">    &quot;key&quot;: &#123;</div><div class="line">        &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">        &quot;size&quot;: 2048</div><div class="line">    &#125;,</div><div class="line">    &quot;names&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;C&quot;: &quot;CN&quot;,</div><div class="line">            &quot;ST&quot;: &quot;BeiJing&quot;,</div><div class="line">            &quot;L&quot;: &quot;BeiJing&quot;,</div><div class="line">            &quot;O&quot;: &quot;k8s&quot;,</div><div class="line">            &quot;OU&quot;: &quot;System&quot;</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>6、生成 kubernetes 证书和私钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</div></pre></td></tr></table></figure></p>
<p>7、创建 admin 证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat &gt; admin-csr.json &lt;&lt; EOF</div><div class="line">&#123;</div><div class="line">  &quot;CN&quot;: &quot;admin&quot;,</div><div class="line">  &quot;hosts&quot;: [],</div><div class="line">  &quot;key&quot;: &#123;</div><div class="line">    &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">    &quot;size&quot;: 2048</div><div class="line">  &#125;,</div><div class="line">  &quot;names&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;C&quot;: &quot;CN&quot;,</div><div class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</div><div class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</div><div class="line">      &quot;O&quot;: &quot;system:masters&quot;,</div><div class="line">      &quot;OU&quot;: &quot;System&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>8、生成 admin 证书和私钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</div></pre></td></tr></table></figure></p>
<p>9、创建 kube-proxy 证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat &gt; kube-proxy-csr.json &lt;&lt; EOF</div><div class="line">&#123;</div><div class="line">  &quot;CN&quot;: &quot;system:kube-proxy&quot;,</div><div class="line">  &quot;hosts&quot;: [],</div><div class="line">  &quot;key&quot;: &#123;</div><div class="line">    &quot;algo&quot;: &quot;rsa&quot;,</div><div class="line">    &quot;size&quot;: 2048</div><div class="line">  &#125;,</div><div class="line">  &quot;names&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;C&quot;: &quot;CN&quot;,</div><div class="line">      &quot;ST&quot;: &quot;BeiJing&quot;,</div><div class="line">      &quot;L&quot;: &quot;BeiJing&quot;,</div><div class="line">      &quot;O&quot;: &quot;k8s&quot;,</div><div class="line">      &quot;OU&quot;: &quot;System&quot;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>10、生成 kube-proxy 客户端证书和私钥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</div></pre></td></tr></table></figure></p>
<p>11、分发证书<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/kubernetes/ssl</div><div class="line">cp *.pem /etc/kubernetes/ssl</div><div class="line"></div><div class="line">scp *.pem 192.168.78.229:/etc/kubernetes/ssl</div><div class="line">scp *.pem 192.168.78.142:/etc/kubernetes/ssl</div></pre></td></tr></table></figure></p>
<p>快照。</p>
<h2 id="搭建etcd集群"><a href="#搭建etcd集群" class="headerlink" title="搭建etcd集群"></a>搭建etcd集群</h2><p>1、在三个节点都需要安装etcd。注意，从这里开始，下载可能需要翻墙。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/coreos/etcd/releases/download/v3.2.12/etcd-v3.2.17-linux-amd64.tar.gz</div><div class="line">tar -xvf etcd-v3.2.17-linux-amd64.tar.gz</div><div class="line">sudo mv etcd-v3.2.17-linux-amd64/etcd* /usr/local/bin</div></pre></td></tr></table></figure></p>
<p>2、创建工作目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo mkdir -p /var/lib/etcd</div></pre></td></tr></table></figure></p>
<p>3、在/usr/lib/systemd/system/目录下创建文件etcd.service，内容如下。注意替换IP地址和主机名。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Etcd Server</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">Documentation=https://github.com/coreos</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">WorkingDirectory=/var/lib/etcd/</div><div class="line">ExecStart=/usr/local/bin/etcd \</div><div class="line">  --name gsj.master.com \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  --peer-cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --peer-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --initial-advertise-peer-urls https://192.168.78.230:2380 \</div><div class="line">  --listen-peer-urls https://192.168.78.230:2380 \</div><div class="line">  --listen-client-urls https://192.168.78.230:2379,http://127.0.0.1:2379 \</div><div class="line">  --advertise-client-urls https://192.168.78.230:2379 \</div><div class="line">  --initial-cluster-token etcd-cluster-0 \</div><div class="line">  --initial-cluster gsj.master.com=https://192.168.78.230:2380,gsj.nodeone.com=https://192.168.78.229:2380,gsj.nodetwo.com=https://192.168.78.142:2380 \</div><div class="line">  --initial-cluster-state new \</div><div class="line">  --data-dir=/var/lib/etcd</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5LimitNOFILE=65536</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure></p>
<p>4、启动etcd<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cp etcd.service /etc/systemd/system/</div><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable etcd</div><div class="line">systemctl start etcd</div><div class="line">systemctl status etcd</div></pre></td></tr></table></figure></p>
<p>我在这一步因为证书错误卡了半天，到晚上突然好了。结果是因为其中一个节点时间慢了，离证书生效的时间差着几个小时…<br>而且之后查看集群状态时还是会提示这个问题，所以为了防止不必要的问题，一定事先做好同步。</p>
<p>验证集群服务是否正常：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">etcdctl \</div><div class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  cluster-health</div></pre></td></tr></table></figure></p>
<h2 id="部署flannel"><a href="#部署flannel" class="headerlink" title="部署flannel"></a>部署flannel</h2><p>1、每台node上都需要安装flannel，master节点上可以不安装。本文中master也作为node使用，因此需所有节点下载安装。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/coreos/flannel/releases/download/v0.9.1/flannel-v0.9.1-linux-amd64.tar.gz</div><div class="line">mkdir flannel</div><div class="line">tar -xzvf flannel-v0.9.1-linux-amd64.tar.gz -C flannel</div><div class="line">sudo cp flannel/&#123;flanneld,mk-docker-opts.sh&#125; /usr/local/bin</div></pre></td></tr></table></figure></p>
<p>2、向 etcd 写入网段信息。这两个命令只需要任意一个节点上执行一次。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">etcdctl --endpoints=https://192.168.78.230:2379,https://192.168.78.229:2379,https://192.168.78.142:2379 \</div><div class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  mkdir /kubernetes/network</div><div class="line"></div><div class="line">etcdctl --endpoints=https://192.168.78.230:2379,https://192.168.78.229:2379,https://192.168.78.142:2379 \</div><div class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  mk /kubernetes/network/config &apos;&#123;&quot;Network&quot;:&quot;172.30.0.0/16&quot;,&quot;SubnetLen&quot;:24,&quot;Backend&quot;:&#123;&quot;Type&quot;:&quot;vxlan&quot;&#125;&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>3、创建systemd unit 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">cat &gt; flanneld.service &lt;&lt; EOF</div><div class="line">[Unit]</div><div class="line">Description=Flanneld overlay address etcd agent</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">After=etcd.service</div><div class="line">Before=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">ExecStart=/usr/local/bin/flanneld \\</div><div class="line">  -etcd-cafile=/etc/kubernetes/ssl/ca.pem \\</div><div class="line">  -etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \\</div><div class="line">  -etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \\</div><div class="line">  -etcd-endpoints=https://192.168.78.230:2379,https://192.168.78.229:2379,https://192.168.78.142:2379 \\</div><div class="line">  -etcd-prefix=/kubernetes/network</div><div class="line">ExecStartPost=/usr/local/bin/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</div><div class="line">Restart=on-failure</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">RequiredBy=docker.service</div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>4、移动并启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sudo mv flanneld.service /etc/systemd/system/</div><div class="line">sudo systemctl daemon-reload</div><div class="line">sudo systemctl enable flanneld</div><div class="line">sudo systemctl start flanneld</div><div class="line">systemctl status flanneld</div></pre></td></tr></table></figure></p>
<p>5、验证<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">etcdctl --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line"> --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line"> --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line"> ls /kubernetes/network/subnets</div></pre></td></tr></table></figure></p>
<p>结果分别对应master、nodetwo、nodeone：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/kubernetes/network/subnets/172.30.8.0-24</div><div class="line">/kubernetes/network/subnets/172.30.99.0-24</div><div class="line">/kubernetes/network/subnets/172.30.30.0-24</div></pre></td></tr></table></figure></p>
<p>查看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">etcdctl --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \get /kubernetes/network/subnets/172.30.8.0-24</div></pre></td></tr></table></figure></p>
<h2 id="安装kubectl工具"><a href="#安装kubectl工具" class="headerlink" title="安装kubectl工具"></a>安装kubectl工具</h2><p>1、下载解压<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">wget https://dl.k8s.io/v1.8.6/kubernetes-client-linux-amd64.tar.gz</div><div class="line">tar -xzvf kubernetes-client-linux-amd64.tar.gz</div><div class="line"></div><div class="line">sudo cp kubernetes/client/bin/kube* /usr/local/bin/</div><div class="line">chmod a+x /usr/local/bin/kube*</div><div class="line">export PATH=/root/local/bin:$PATH</div></pre></td></tr></table></figure></p>
<p>2、创建kubeconfig<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># 设置集群参数,--server指定Master节点ip</div><div class="line">kubectl config set-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --server=https://192.168.78.230:6443</div><div class="line"></div><div class="line"># 设置客户端认证参数</div><div class="line">kubectl config set-credentials admin \</div><div class="line">  --client-certificate=/etc/kubernetes/ssl/admin.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --client-key=/etc/kubernetes/ssl/admin-key.pem</div><div class="line"></div><div class="line"># 设置上下文参数</div><div class="line">kubectl config set-context kubernetes \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=admin</div><div class="line"></div><div class="line"># 设置默认上下文</div><div class="line">kubectl config use-context kubernetes</div></pre></td></tr></table></figure></p>
<p>2、创建TLS Bootstrapping Token<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">#生成token 变量</div><div class="line">export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d &apos; &apos;)</div><div class="line"></div><div class="line">cat &gt; token.csv &lt;&lt;EOF</div><div class="line">$&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,&quot;system:kubelet-bootstrap&quot;</div><div class="line">EOF</div><div class="line">mv token.csv /etc/kubernetes/</div></pre></td></tr></table></figure></p>
<p>3、创建 kubelet bootstrapping kubeconfig文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># 设置集群参数--server为master节点ip</div><div class="line">kubectl config set-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --server=https://192.168.78.230:6443 \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"># 设置客户端认证参数</div><div class="line">kubectl config set-credentials kubelet-bootstrap \</div><div class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"># 设置上下文参数</div><div class="line">kubectl config set-context default \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kubelet-bootstrap \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"># 设置默认上下文</div><div class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line">mv bootstrap.kubeconfig /etc/kubernetes/</div></pre></td></tr></table></figure></p>
<p>4、创建kube-proxy.kubeconfig<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># 设置集群参数 --server参数为master ip</div><div class="line">kubectl config set-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --server=https://192.168.78.230:6443 \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"></div><div class="line"># 设置客户端认证参数</div><div class="line">kubectl config set-credentials kube-proxy \</div><div class="line">  --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem \</div><div class="line">  --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"></div><div class="line"># 设置上下文参数</div><div class="line">kubectl config set-context default \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kube-proxy \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"></div><div class="line"># 设置默认上下文</div><div class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</div><div class="line">mv kube-proxy.kubeconfig /etc/kubernetes/</div></pre></td></tr></table></figure></p>
<p>5、生成的bootstrap.kubeconfig，kube-proxy.kubeconfig文件拷贝到其它node节点的/etc/kubernetes目录下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">scp /etc/kubernetes/kube-proxy.kubeconfig gsj.nodeone.com:/etc/kubernetes/</div><div class="line">scp /etc/kubernetes/bootstrap.kubeconfig  gsj.nodeone.com:/etc/kubernetes/</div><div class="line"></div><div class="line">scp /etc/kubernetes/kube-proxy.kubeconfig gsj.nodetwo.com:/etc/kubernetes/</div><div class="line">scp /etc/kubernetes/bootstrap.kubeconfig  gsj.nodetwo.com:/etc/kubernetes/</div></pre></td></tr></table></figure></p>
<h2 id="部署master"><a href="#部署master" class="headerlink" title="部署master"></a>部署master</h2><p>主要包含三个组件apiserver scheduler controller-manager。<br>1、下载解压kubernetes</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dl.k8s.io/v1.8.6/kubernetes-server-linux-amd64.tar.gz</div><div class="line">tar -xzvf kubernetes-server-linux-amd64.tar.gz</div><div class="line">cp -r kubernetes/server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/local/bin/</div></pre></td></tr></table></figure>
<p>2、配置和启动 kube-apiserver</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">cat &gt; kube-apiserver.service &lt;&lt; EOF</div><div class="line">[Unit]</div><div class="line">Description=Kubernetes API Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line">After=etcd.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/local/bin/kube-apiserver \\</div><div class="line">  --logtostderr=true \\</div><div class="line">  --admission-control=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota,NodeRestriction \\</div><div class="line">  --advertise-address=192.168.78.230 \\</div><div class="line">  --bind-address=192.168.78.230 \\</div><div class="line">  --insecure-bind-address=127.0.0.1 \\</div><div class="line">  --authorization-mode=Node,RBAC \\</div><div class="line">  --runtime-config=rbac.authorization.k8s.io/v1alpha1 \\</div><div class="line">  --kubelet-https=true \\</div><div class="line">  --enable-bootstrap-token-auth \\</div><div class="line">  --token-auth-file=/etc/kubernetes/token.csv \\</div><div class="line">  --service-cluster-ip-range=10.254.0.0/16 \\</div><div class="line">  --service-node-port-range=8400-10000 \\</div><div class="line">  --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem \\</div><div class="line">  --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \\</div><div class="line">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \\</div><div class="line">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \\</div><div class="line">  --etcd-cafile=/etc/kubernetes/ssl/ca.pem \\</div><div class="line">  --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem \\</div><div class="line">  --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem \\</div><div class="line">  --etcd-servers=https://192.168.78.230:2379,https://192.168.78.229:2379,https://192.168.78.142:2379 \\</div><div class="line">  --enable-swagger-ui=true \\</div><div class="line">  --allow-privileged=true \\</div><div class="line">  --apiserver-count=3 \\</div><div class="line">  --audit-log-maxage=30 \\</div><div class="line">  --audit-log-maxbackup=3 \\</div><div class="line">  --audit-log-maxsize=100 \\</div><div class="line">  --audit-log-path=/var/lib/audit.log \\</div><div class="line">  --event-ttl=1h \\</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">Type=notify</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>移动并启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cp kube-apiserver.service /etc/systemd/system/</div><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable kube-apiserver</div><div class="line">systemctl start kube-apiserver</div><div class="line">systemctl status kube-apiserver</div></pre></td></tr></table></figure>
<p>3、配置和启动 kube-controller-manager</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">cat &gt; kube-controller-manager.service &lt;&lt; EOF</div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Controller Manager</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/local/bin/kube-controller-manager \\</div><div class="line">  --logtostderr=true  \\</div><div class="line">  --address=127.0.0.1 \\</div><div class="line">  --master=http://127.0.0.1:8080 \\</div><div class="line">  --allocate-node-cidrs=true \\</div><div class="line">  --service-cluster-ip-range=10.254.0.0/16 \\</div><div class="line">  --cluster-cidr=172.30.0.0/16 \\</div><div class="line">  --cluster-name=kubernetes \\</div><div class="line">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \\</div><div class="line">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\</div><div class="line">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \\</div><div class="line">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \\</div><div class="line">  --leader-elect=true \\</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>移动并启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cp kube-controller-manager.service /etc/systemd/system/</div><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable kube-controller-manager</div><div class="line">systemctl start kube-controller-manager</div></pre></td></tr></table></figure>
<p>4、配置和启动 kube-scheduler</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat &gt; kube-scheduler.service &lt;&lt; EOF</div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Scheduler</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">ExecStart=/usr/local/bin/kube-scheduler \\</div><div class="line">  --logtostderr=true \\</div><div class="line">  --address=127.0.0.1 \\</div><div class="line">  --master=http://127.0.0.1:8080 \\</div><div class="line">  --leader-elect=true \\</div><div class="line">  --v=2</div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">EOF</div></pre></td></tr></table></figure>
<p>移动并启动：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cp kube-scheduler.service /etc/systemd/system/</div><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable kube-scheduler</div><div class="line">systemctl start kube-scheduler</div></pre></td></tr></table></figure>
<p>5、验证 master 节点功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl get componentstatuses</div></pre></td></tr></table></figure>
<p>正常结果为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">scheduler            Healthy   ok                   </div><div class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </div><div class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </div><div class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</div></pre></td></tr></table></figure>
<h2 id="部署node"><a href="#部署node" class="headerlink" title="部署node"></a>部署node</h2><h3 id="安装启动docker"><a href="#安装启动docker" class="headerlink" title="安装启动docker"></a>安装启动docker</h3><p>卸载已安装的docker：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum list installed | grep docker</div><div class="line">yum remove ---</div><div class="line">rm -rf /var/lib/docker</div></pre></td></tr></table></figure></p>
<p>三个节点都需执行此操作。Docker版本是17.12。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">tar -xvzf docker-17.12.0-ce.tgz </div><div class="line">cp docker/docker* /usr/local/bin</div><div class="line"></div><div class="line">cat &gt; docker.service &lt;&lt; EOF</div><div class="line">[Unit]</div><div class="line">Description=Docker Application Container Engine</div><div class="line">Documentation=http://docs.docker.io</div><div class="line"></div><div class="line">[Service]</div><div class="line">Environment=&quot;PATH=/usr/local/bin:/bin:/sbin:/usr/bin:/usr/sbin&quot;</div><div class="line">EnvironmentFile=-/run/flannel/subnet.env</div><div class="line">EnvironmentFile=-/run/flannel/docker</div><div class="line">ExecStart=/usr/local/bin/dockerd \\</div><div class="line">  --exec-opt native.cgroupdriver=cgroupfs \\</div><div class="line">  --log-level=error \\</div><div class="line">  --log-driver=json-file \\</div><div class="line">  --storage-driver=overlay \\</div><div class="line">  \$DOCKER_NETWORK_OPTIONS</div><div class="line">ExecReload=/bin/kill -s HUP \$MAINPID</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=infinity</div><div class="line">LimitNPROC=infinity</div><div class="line">LimitCORE=infinity</div><div class="line">Delegate=yes</div><div class="line">KillMode=process</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">EOF</div><div class="line"></div><div class="line">cp docker.service /etc/systemd/system/docker.service</div><div class="line"></div><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable docker</div><div class="line">systemctl start docker</div><div class="line">docker version</div></pre></td></tr></table></figure></p>
<h3 id="配置kubectl"><a href="#配置kubectl" class="headerlink" title="配置kubectl"></a>配置kubectl</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kubectl create clusterrolebinding kubelet-bootstrap \</div><div class="line">  --clusterrole=system:node-bootstrapper \</div><div class="line">  --user=kubelet-bootstrap</div></pre></td></tr></table></figure>
<p>第一次报错：rpc error: code = Internal transport is closing<br>但第二次就成功了，原因暂未知：clusterrolebinding “kubelet-bootstrap” created</p>
<h3 id="kubelet和kube-proxy安装"><a href="#kubelet和kube-proxy安装" class="headerlink" title="kubelet和kube-proxy安装"></a>kubelet和kube-proxy安装</h3><p>相关文件已经包含在kubernete-server压缩包。<br>1、首先创建kubelet 工作目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sudo mkdir /var/lib/kubelet</div></pre></td></tr></table></figure></p>
<p>2、配置启动kubelet<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">cat &gt; kubelet.service &lt;&lt; EOF</div><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kubelet</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=docker.service</div><div class="line">Requires=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">WorkingDirectory=/var/lib/kubelet</div><div class="line">ExecStart=/usr/local/bin/kubelet \\</div><div class="line">  --address=192.168.78.230 \\</div><div class="line">  --hostname-override=192.168.78.230 \\</div><div class="line">  --pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest \\</div><div class="line">  --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig \\</div><div class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</div><div class="line">  --require-kubeconfig \\</div><div class="line">  --cert-dir=/etc/kubernetes/ssl \\</div><div class="line">  --container-runtime=docker \\</div><div class="line">  --cluster-dns=10.254.0.2 \\</div><div class="line">  --cluster-domain=cluster.local \\</div><div class="line">  --hairpin-mode promiscuous-bridge \\</div><div class="line">  --allow-privileged=true \\</div><div class="line">  --serialize-image-pulls=false \\</div><div class="line">  --register-node=true \\</div><div class="line">  --logtostderr=true \\</div><div class="line">  --cgroup-driver=cgroupfs  \\</div><div class="line">  --v=0</div><div class="line"></div><div class="line">Restart=on-failure</div><div class="line">KillMode=process</div><div class="line">LimitNOFILE=65536</div><div class="line">RestartSec=5</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">EOF</div></pre></td></tr></table></figure></p>

      
    </div>

    <div>
      
        
      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/k8s/" rel="tag">#k8s</a>
          
            <a href="/tags/docker/" rel="tag">#docker</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2017/12/20/14-云安全/" rel="next" title="云安全/租户隔离  -调研总结">
                <i class="fa fa-chevron-left"></i> 云安全/租户隔离  -调研总结
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/01/20/20-kubeadm-k8s搭建记录/" rel="prev" title="kubernete+calico(canal)环境搭建流程和问题记录（kubeadm）">
                kubernete+calico(canal)环境搭建流程和问题记录（kubeadm） <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/uploads/x.png"
               alt="cuteme" />
          <p class="site-author-name" itemprop="name">cuteme</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">17</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">7</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">19</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#环境"><span class="nav-number">1.</span> <span class="nav-text">环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统准备"><span class="nav-number">2.</span> <span class="nav-text">系统准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署准备-创建和分发证书"><span class="nav-number">3.</span> <span class="nav-text">部署准备:创建和分发证书</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#创建TLS证书和秘钥"><span class="nav-number">4.</span> <span class="nav-text">创建TLS证书和秘钥</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#搭建etcd集群"><span class="nav-number">5.</span> <span class="nav-text">搭建etcd集群</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署flannel"><span class="nav-number">6.</span> <span class="nav-text">部署flannel</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装kubectl工具"><span class="nav-number">7.</span> <span class="nav-text">安装kubectl工具</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署master"><span class="nav-number">8.</span> <span class="nav-text">部署master</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#部署node"><span class="nav-number">9.</span> <span class="nav-text">部署node</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装启动docker"><span class="nav-number">9.1.</span> <span class="nav-text">安装启动docker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置kubectl"><span class="nav-number">9.2.</span> <span class="nav-text">配置kubectl</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet和kube-proxy安装"><span class="nav-number">9.3.</span> <span class="nav-text">kubelet和kube-proxy安装</span></a></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">cuteme</span>
</div>

<div class="powered-by">
  a404
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  



  



  
  
  

  

  

</body>
</html>
